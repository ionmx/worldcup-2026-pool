{
  "rules": {
    // Matches - anyone can read, only admins can write
    "matches": {
      ".read": true,
      ".write": "auth != null && root.child('users').child(auth.uid).child('admin').val() === true"
    },

    // Users - anyone can read, users can only write their own profile
    "users": {
      ".read": true,
      "$userId": {
        ".write": "auth != null && auth.uid === $userId",
        // Prevent users from making themselves admin
        "admin": {
          ".write": "auth != null && root.child('users').child(auth.uid).child('admin').val() === true"
        }
      }
    },

    // Usernames index - anyone can read, special write rules
    "usernames": {
      ".read": true,
      "$normalizedUsername": {
        // Can write if: claiming for yourself OR admin
        ".write": "auth != null && (newData.val() === auth.uid || !data.exists() || data.val() === auth.uid)"
      }
    },

    // Predictions - anyone can read, users can only write their own
    "predictions": {
      "$userId": {
        // Anyone can read predictions (to view other users' predictions)
        ".read": true,
        "$gameId": {
          // Users can write their own predictions at least 10 mins before kickoff
          // Match timestamp is in seconds, now is in milliseconds
          ".write": "auth != null && auth.uid === $userId && (now < root.child('matches').child($gameId).child('timestamp').val() * 1000 - 600000)",
          // Validate prediction structure
          ".validate": "newData.hasChildren(['homePrediction', 'awayPrediction', 'points', 'updatedAt'])",
          "homePrediction": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 99"
          },
          "awayPrediction": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 99"
          },
          "points": {
            // Users can only set points to 0, admins/functions can set any value
            ".validate": "newData.isNumber() && newData.val() >= 0 && (newData.val() === 0 || root.child('users').child(auth.uid).child('admin').val() === true)"
          },
          "updatedAt": {
            ".validate": "newData.isNumber()"
          }
        }
      }
    },

    // Leagues - anyone can read, owner can write
    "leagues": {
      ".read": true,
      "$leagueId": {
        // Only owner can update league settings
        ".write": "auth != null && (data.child('ownerId').val() === auth.uid || !data.exists())"
      }
    },

    // League slugs index - maps slug to leagueId
    "leagueSlugs": {
      ".read": true,
      "$slug": {
        ".write": "auth != null && (!data.exists() || root.child('leagues').child(data.val()).child('ownerId').val() === auth.uid)"
      }
    },

    // League members - who is in each league
    "leagueMembers": {
      ".read": true,
      "$leagueId": {
        "$userId": {
          // Users can add/remove themselves
          ".write": "auth != null && auth.uid === $userId"
        }
      }
    },

    // User leagues - reverse index for quick lookup of user's leagues
    "userLeagues": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        "$leagueId": {
          ".write": "auth != null && auth.uid === $userId"
        }
      }
    },

    // Default deny all other paths
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
